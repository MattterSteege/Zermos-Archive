@model Zermos_Web.Models.Somtoday.SomtodayPreAuthenticationModel

<link rel="stylesheet" href="/css/koppelingen.css" preload/>

<script minimize>
@Context.Items["dmjs"]

    var modal = new ZermosModal()
    .addHeading({text: "Koppel Somtoday aan je account!"})
    .addList({items: [
        "Kopieer de code en open de Somtoday leerling app op je mobiel (werkt niet op pc/laptop). Log uit als je al bent ingelogd.",
        "Klik vijf keer op het Somtoday logo op het inlogscherm. Kies 'Ontwikkel' in de lijst. Vul de eerder gekopieerde code in bij het veld onderaan.",
        "Klik op 'Inloggen'. Als je niet automatisch wordt ingelogd, voer dan je inloggegevens in. Verwacht een foutmelding na het inloggen; dit betekent dat je succesvol bent ingelogd op Zermos.",
        "Ga terug naar de Zermos app, je wordt automatisch naar je accountpagina geleid."
    ], listType: "ol"})
    .addUrl({url: "@Model.vanityUrl", showFull: true, copyButton: false})
    .addButton({text: "Kopieer code", onClick: () => {
        copyToClipboard("@Model.vanityUrl");
    }})
    .addButton({text: "Open mobiele Somtoday app", onClick: () => {
        window.location.href = "somtoday://nl.topicus.somtoday.leerling/oauth/callback";
    }})
    .openTroughAppending(main);
    
    
    var CheckingTimeout = null;

    setTimeout(function() {
        SendCheck();
    }, 10000);

    Zermos.mainUnload = function() {
        clearTimeout(CheckingTimeout);
    };

    function SendCheck() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/Koppelingen/Somtoday/STAP/isCompleted");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    if (xhr.responseText === "true") {
                        clearInterval(CheckingTimeout);
                        newSidebar();
                        ReplacePage('@Url.Action("Account", "Account")');
                    } else {
                        CheckingTimeout = setTimeout(function() {
                            SendCheck();
                        }, 2500);
                    }
                }
                else {
                    CheckingTimeout = setTimeout(function() {
                        SendCheck();
                    }, 2500);
                }
            }
        };
        xhr.send();
    }
</script>