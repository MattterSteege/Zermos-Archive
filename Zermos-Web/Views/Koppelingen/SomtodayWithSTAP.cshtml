@model Zermos_Web.Models.Somtoday.SomtodayPreAuthenticationModel

<link rel="stylesheet" href="/css/koppelingen.css" preload/>

<script minimize>
@Context.Items["dmjs"]

    var modal = new ZermosModal()
    .addHeading({text: "Koppel Somtoday aan je account!"})
    .addHeading({text: "Kopieer deze code of zorg ervoor dat je de code goed onthoudt, want je hebt hem later nodig. Open vervolgens de Somtoday leerling app op je mobiel. Dit proces werkt alleen op een mobiel apparaat en niet op een pc of laptop. Je kunt de app handmatig openen, of, als er een 'open Somtoday' knop hieronder staat, daarop klikken. Als je al ingelogd bent in de app, log dan eerst uit."})
    .addHeading({text: "Zodra je op het inlogscherm bent, moet je vijf keer achter elkaar op het Somtoday logo bovenaan het scherm klikken. Dit opent een lijst met verschillende opties, zoals 'Nightly', 'Productie' en 'Ontwikkel'. Kies in deze lijst voor 'Ontwikkel'. Onderaan het scherm verschijnt nu een invulveld met de tekst \"hostname of ip indien niet localhost\". Hier vul je de eerder gekopieerde of onthouden code in."})
    .addHeading({text: "Klik daarna op 'Inloggen'. Als je niet automatisch wordt ingelogd, voer dan je inloggegevens in zoals je dat normaal zou doen. Dit is de echte Somtoday inlogpagina, dus je wachtwoord is veilig en wordt niet gestolen of bekeken. Nadat je bent ingelogd, opent de Somtoday app automatisch en krijg je waarschijnlijk een foutmelding te zien. Dit is normaal en betekent dat je succesvol bent ingelogd op Zermos. Ga vervolgens terug naar de Zermos app."})
    .addHeading({text: "Als je terug bent bij Zermos en alles goed is gegaan, word je automatisch teruggestuurd naar je accountpagina."})
    .addSpacer({height: "var(--padding)"})
    .addUrl({url: "@Model.vanityUrl", showFull: true, copyButton: false})
    .addButton({text: "Kopieer code", onClick: () => {
        copyToClipboard("@Model.vanityUrl");
    }})
    .addButton({text: "Open mobiele Somtoday app", onClick: () => {
        window.location.href = "somtoday://nl.topicus.somtoday.leerling/oauth/callback";
    }})
    .open();
    
    
    var CheckingTimeout = null;

    setTimeout(function() {
        SendCheck();
    }, 10000);

    Zermos.mainUnload = function() {
        clearTimeout(CheckingTimeout);
    };

    function SendCheck() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "/Koppelingen/Somtoday/STAP/isCompleted");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4) {
                if (xhr.status === 200) {
                    if (xhr.responseText === "true") {
                        clearInterval(CheckingTimeout);
                        newSidebar();
                        ReplacePage('@Url.Action("Account", "Account")');
                    } else {
                        CheckingTimeout = setTimeout(function() {
                            SendCheck();
                        }, 2500);
                    }
                }
                else {
                    CheckingTimeout = setTimeout(function() {
                        SendCheck();
                    }, 2500);
                }
            }
        };
        xhr.send();
    }
</script>