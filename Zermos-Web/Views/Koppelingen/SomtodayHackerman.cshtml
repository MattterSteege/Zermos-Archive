<link rel="stylesheet" href="/css/koppelingen.css" preload/>

@{
    
string code = @"
// Stap 1: We maken twee hulpmiddelen
const ontcijferGeheimschrift = JSON.parse;
const geheugen = localStorage;

// Stap 2: We bouwen een speciale webadres en gaan er naartoe
copy( 
    // Stap 3: We halen een geheime sleutel op
    ontcijferGeheimschrift(
        // Stap 4: We zoeken naar de juiste doos met gegevens
        geheugen[
            'CapacitorStorage.' + 
            // Stap 5: We vinden de naam van de huidige inloggegevens
            ontcijferGeheimschrift(
                // Stap 6: We halen de lijst met alle inloggegevens op
                geheugen['CapacitorStorage.SL_AUTH_CONFIG_RECORDS']
            ).currentSessionIdentifier.UUID
        ]
    ).refresh_token);

console.log('De code is gekopieerd naar je klembord, plak deze in het veld op de koppelpagina van Zermos');
";
    
}

<script minimize>
@Context.Items["dmjs"]

        new ZermosModal()
        .addHeading({text: "Koppel Somtoday aan je account!"})
        .addText({text: "Ben jij die hackerman met een Somtoday account waarbij je een externe login provider gebruikt, dan is deze methode voor jouw. Als je deze stappen goed volgt, dan komt alles goed:"})
        .addList({items: [
            "Open de website van Somtoday (met de knop hieronder) en log in totdat je bijv. je rooster of cijfers ziet.",
            "Open de console (Ctrl + Shift + J Of Cmd + Option + J)",
            "Plak de code in de console en klik op enter",
            "Wacht totdat de koppeling gelukt is",
        ], listType: "ol"})
        .addLabel({text: "*Mocht het mis gaan dan is het een goed idee om op de website van Somtoday uit te loggen en via de knop hieronder opnieuw in te loggen."})
        .addText({text: "Als je op 'kopieer' klikt, dan kopieer je de exacte versie als degene die hieronder is beschreven, mocht je het niet vertrouwen vraag dan aan iemand met computerkennis of deze code veilig is!"})
        .addCodeBlock({code: `@Html.Raw(code)`})
        .addButton({text: "Open Somtoday", onClick: () => {
            window.open('https://leerling.somtoday.nl/login?splash=true','_blank');
        }})
        .addButton({text: "Ik heb (al) een Somtoday token", onClick: (ctx) => {
            new ZermosModal()
            .addHeading({text: "Je bent er bijna!"})
            .addHeading({text: "Je hebt zojuist de code in je klembord gekregen, plak deze code hieronder en klik op 'Koppel Somtoday aan je account!'"})
            .addLabel({text: "Somtoday code:"})
            .addTextInput({required: true})
            .addButton({text: "Koppel Somtoday aan je account!", onClick: (ctx) => {
                var code = ctx.getComponentsValue().values[0].value;

                if (code.startsWith("ey")) {
                    ReplacePage('/Koppelingen/Somtoday/Callback?' + code);
                }
            }})
            .openTroughAppending(main);
            
            ctx.close();
        }})
        .openTroughAppending(main);
    
</script>
